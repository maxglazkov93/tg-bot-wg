#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ WireGuard —Å–µ—Ä–≤–µ—Ä–µ
# –ó–∞–ø—É—Å–∫–∞—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ root

set -e

echo "üîß –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ WireGuard —Å–µ—Ä–≤–µ—Ä–µ..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ WireGuard
if ! command -v wg &> /dev/null; then
    echo "‚ùå WireGuard –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ WireGuard
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ WireGuard..."
if systemctl is-active --quiet wg-quick@wg0; then
    echo "‚úÖ WireGuard –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ö†Ô∏è  WireGuard –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π —Å–µ—Ä–≤–µ—Ä–∞
if [ -f "/etc/wireguard/private.key" ] && [ -f "/etc/wireguard/public.key" ]; then
    PRIVATE_KEY=$(cat /etc/wireguard/private.key)
    PUBLIC_KEY=$(cat /etc/wireguard/public.key)
    
    echo "üìã –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞: $PUBLIC_KEY"
    echo "üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–µ—Ä–≤–µ—Ä–∞: $PRIVATE_KEY"
else
    echo "‚ö†Ô∏è  –ö–ª—é—á–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "/etc/wireguard/wg0.conf" ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞"
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    echo "üìã –¢–µ–∫—É—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã:"
    wg show | grep -A 10 "peer:" || echo "   –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
else
    echo "‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
if [ -d "/etc/wireguard/clients" ]; then
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–∞"
    CLIENT_COUNT=$(ls /etc/wireguard/clients/*.conf 2>/dev/null | wc -l)
    echo "üìÅ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤: $CLIENT_COUNT"
else
    echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞:"
echo "   IP —Å–µ—Ä–≤–µ—Ä–∞: 5.129.213.216"
echo "   –ü–æ—Ä—Ç: 65338"
echo "   –ü–æ–¥—Å–µ—Ç—å: 10.66.66.0/24"
echo "   IPv6-–ø–æ–¥—Å–µ—Ç—å: fd42:42:42:1/64"
echo "   DNS: 1.1.1.1, 1.0.0.1"
echo ""
echo "üîß –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WireGuard –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   sudo wg show                    # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å"
echo "   sudo systemctl status wg-quick@wg0  # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞"
echo "   sudo systemctl restart wg-quick@wg0 # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo "   ls /etc/wireguard/clients/      # –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤" 